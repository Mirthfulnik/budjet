<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Finance 2026</title>

  <style>
    :root{
      --bg:#0f1115; --card:#171a22; --card2:#1c2030;
      --text:#e9eef6; --muted:#9aa3b2; --line:#2a3142;
      --accent:#57a6ff; --danger:#ff5b6e; --ok:#41d38d; --warn:#ffcc66;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --navH: 70px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
       padding-bottom: calc(var(--navH) + var(--safeB) + 34px);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit}
    .wrap{max-width:1100px; margin:0 auto; padding:14px; padding-top: calc(12px + var(--safeT));}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    @media (max-width: 560px){
  .grid{ gap:14px; }
  .card{ padding: 14px; }
}
    @media (min-width: 980px){
      .grid.cols2{grid-template-columns: 1.1fr .9fr;}
      .grid.cols3{grid-template-columns: 1fr 1fr 1fr;}
      .grid.cols2wide{grid-template-columns: 1.6fr .4fr;}
    }
    /* === Mobile layout fix: no 2-column rows on narrow screens === */
@media (max-width: 560px){
  .row{ gap:12px; }
  .row > *{ flex: 1 1 100%; min-width: 0; }
}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0 0 10px 0;
    }
    .cardTitle h2{
      margin:0; font-size:16px; letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--muted); font-size:12px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(87,166,255,.18);
      color: var(--text);
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{background: rgba(255,255,255,.06); font-weight:650}
    .btn.danger{background: rgba(255,91,110,.18); border-color: rgba(255,91,110,.35)}
    .btn.inline{width:auto; padding:9px 10px}
    .btn.small{padding:8px 10px; font-size:13px}
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.08);
    }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{min-height: 88px; resize: vertical;}
    label{display:block; font-size:12px; color:var(--muted); margin: 0 0 6px 2px}
    .field{margin-bottom:10px}
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding:12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .kpi .val{font-size:18px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .delta{font-size:12px; font-weight:700}
    .delta.up{color: var(--ok)}
    .delta.down{color: var(--danger)}
    .delta.flat{color: var(--muted)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .item .left{display:flex; flex-direction:column; gap:4px; min-width:0}
    .item .right{display:flex; align-items:center; gap:8px; flex-shrink:0}
    .item .t{font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .item .d{color:var(--muted); font-size:12px}
    .tag{
      display:inline-flex; align-items:center;
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.03);
    }
    .tag.income{border-color: rgba(65,211,141,.35); color: rgba(65,211,141,.95)}
    .tag.expense{border-color: rgba(255,91,110,.35); color: rgba(255,91,110,.95)}
    .tag.transfer{border-color: rgba(255,204,102,.35); color: rgba(255,204,102,.95)}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .progress{
      height:10px; border-radius: 999px; background: rgba(255,255,255,.06);
      overflow:hidden; border:1px solid rgba(255,255,255,.06);
    }
    .progress > i{display:block; height:100%; width:0%;}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .sectionTitle{margin:0 0 10px 2px; font-size:13px; color: var(--muted)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      font-weight:750;
    }
    .tab.active{color: var(--text); border-color: rgba(87,166,255,.45); background: rgba(87,166,255,.14)}
    /* pages */
    .page{display:none}
    .page.active{display:block}

    /* bottom nav */
    .nav{
      position: fixed;
      left: 12px; right: 12px;
      bottom: calc(10px + var(--safeB));
      height: var(--navH);
      border-radius: 18px;
      background: rgba(10,12,18,.72);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(14px);
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 10px;
      z-index: 50;
      box-shadow: var(--shadow);
      max-width: 1100px;
      margin: 0 auto;
    }
    .nav .btnNav{
      flex:1 1 auto;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px;
      height:100%;
      border-radius: 14px;
      cursor:pointer;
      color: var(--muted);
      user-select:none;
      padding: 8px 6px;
      border:1px solid transparent;
    }
    .nav .btnNav.active{
      color: var(--text);
      border-color: rgba(87,166,255,.35);
      background: rgba(87,166,255,.12);
    }
    .nav .btnNav .ico{font-size:18px}
    .nav .btnNav .lbl{font-size:11px; font-weight:800; letter-spacing:.2px}
    .nav .btnNav.sync{
      flex: 0 0 120px;
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
    }

    /* sync toast/modal */
    .toast{
      position: fixed;
      left: 12px; right: 12px;
      bottom: calc(var(--navH) + 34px + var(--safeB));
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(23,26,34,.92);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:none;
      z-index: 60;
    }
    .toast.show{display:block}
    .toastTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .toastTitle{font-weight:900}
    .toastBody{margin-top:8px; color: var(--muted); font-size:12px; line-height:1.35; white-space:pre-wrap}
    .x{
      width:32px; height:32px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 10px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      user-select:none;
    }

    canvas{width:100%; height:260px; display:block}
    .canvasWrap{height:260px}
    @media (max-width: 420px){
      canvas{height:240px}
      .canvasWrap{height:240px}
      .nav .btnNav.sync{flex:0 0 95px}
    }

    /* modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      z-index: 80;
      padding: 14px;
      padding-bottom: calc(14px + var(--safeB));
    }
    .modalBack.show{display:flex}
    .modal{
      width:100%; max-width: 640px;
      background: rgba(23,26,34,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalHead h3{margin:0; font-size:15px}
    .modalBody{padding: 12px 12px}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- PULT -->
    <section id="page-pult" class="page active">
      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h2>
            <span class="pill" id="pill-month"></span>
          </div>

          <div class="row">
            <div class="field">
              <label>–¢–∏–ø</label>
              <select id="op-type">
                <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                <option value="income">–î–æ—Ö–æ–¥</option>
                <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
              </select>
            </div>

            <div class="field">
              <label>–°—É–º–º–∞</label>
              <input id="op-amount" type="number" inputmode="decimal" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select id="op-category"></select>
            </div>
            <div class="field">
              <label>–°—á—ë—Ç</label>
              <select id="op-account"></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>–î–∞—Ç–∞</label>
              <input id="op-date" type="date" />
            </div>
            <div class="field">
              <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
              <input id="op-comment" type="text" placeholder="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" />
            </div>
          </div>

          <button class="btn" id="btn-add-op">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
          <div class="hint" style="margin-top:8px">
            –£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî —á–µ—Ä–µ–∑ –∫—Ä–µ—Å—Ç–∏–∫ –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º).
          </div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–õ–∏–º–∏—Ç—ã (–º–µ—Å—è—Ü)</h2>
            <span class="pill" id="pill-limits"></span>
          </div>
          <div id="limits-view" class="list"></div>
          <div class="hint" style="margin-top:10px">
            –õ–∏–º–∏—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Google –¢–∞–±–ª–∏—Ü–µ, –Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">
          <h2>–û–ø–µ—Ä–∞—Ü–∏–∏</h2>
          <div class="row" style="flex:0 0 auto; gap:8px">
            <button class="btn inline small ghost" id="btn-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div id="ops-view"></div>
      </div>

      <div class="card">
        <div class="cardTitle">
          <h2>–ü–ª–∞–Ω –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</h2>
          <span class="pill">–ø–æ —Ü–µ–ª—è–º</span>
        </div>
        <div id="saving-plan" class="list"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="page">
      <div class="card">
        <div class="cardTitle">
          <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
          <span class="pill" id="pill-period"></span>
        </div>

        <div class="tabs" id="period-tabs">
          <div class="tab active" data-period="week">–ù–µ–¥–µ–ª—è</div>
          <div class="tab" data-period="month">–ú–µ—Å—è—Ü</div>
          <div class="tab" data-period="year">–ì–æ–¥</div>
          <div class="tab" data-period="custom">–ü–µ—Ä–∏–æ–¥</div>
        </div>

        <div id="custom-range" style="display:none; margin-top:10px" class="row">
          <div class="field">
            <label>–°</label>
            <input id="range-from" type="date" />
          </div>
          <div class="field">
            <label>–ü–æ</label>
            <input id="range-to" type="date" />
          </div>
          <div class="field" style="align-self:flex-end">
            <button class="btn secondary" id="btn-apply-range">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid cols3" id="kpi-row"></div>
      </div>

      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–î–∏–Ω–∞–º–∏–∫–∞ (–¥–æ—Ö–æ–¥—ã/—Ä–∞—Å—Ö–æ–¥—ã/–±–∞–ª–∞–Ω—Å)</h2>
            <span class="pill">—Å—Ç–æ–ª–±—Ü—ã</span>
          </div>
          <div class="canvasWrap"><canvas id="bar-chart"></canvas></div>
          <div class="hint">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ ‚Äî —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π.</div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
            <span class="pill">–∫—Ä—É–≥</span>
          </div>
          <div class="row">
            <div style="flex:1 1 300px">
              <div class="sectionTitle">–†–∞—Å—Ö–æ–¥—ã</div>
              <div class="canvasWrap"><canvas id="pie-expense"></canvas></div>
            </div>
            <div style="flex:1 1 300px">
              <div class="sectionTitle">–î–æ—Ö–æ–¥—ã</div>
              <div class="canvasWrap"><canvas id="pie-income"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–¢–û–ü –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
            <span class="pill">Top-5</span>
          </div>
          <div id="top-expense" class="list"></div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–¢–û–ü –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤</h2>
            <span class="pill">Top-5</span>
          </div>
          <div id="top-income" class="list"></div>
        </div>
      </div>
    </section>

    <!-- GOALS -->
    <section id="page-goals" class="page">
      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–¶–µ–ª–∏</h2>
            <button class="btn inline small" id="btn-new-goal">+ –¶–µ–ª—å</button>
          </div>
          <div id="goals-list" class="list"></div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —à–∫–∞–ª–∞ (–¥–æ—Ö–æ–¥)</h2>
            <span class="pill">—Å—Ç–æ–ª–±—á–∞—Ç–∞—è</span>
          </div>
          <div class="hint" style="margin-bottom:8px">
            –í–Ω–∏–∑—É: ¬´–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî 150 000 ‚ÇΩ¬ª. –ù–∞–≤–µ—Ä—Ö—É: —Ü–µ–ª—å 2026 –≥–æ–¥–∞. –≠—Ç–∞–ø—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.
          </div>
          <div class="canvasWrap"><canvas id="motivation-bar"></canvas></div>
          <div class="hr"></div>
          <div class="row">
            <div class="kpi">
              <div class="sub">–¢–µ–∫—É—â–∏–π —Å—Ä–µ–¥–Ω–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</div>
              <div class="val" id="mot-cur">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="sub">–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</div>
              <div class="val" id="mot-next">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="sub">–ù—É–∂–Ω–æ –ø—Ä–∏–±–∞–≤–∏—Ç—å</div>
              <div class="val" id="mot-gap">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="page-settings" class="page">
      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            <button class="btn inline small" id="btn-new-cat">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
          </div>
          <div id="cats-list" class="list"></div>
          <div class="hint" style="margin-top:10px">
            –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Google –¢–∞–±–ª–∏—Ü–µ, –Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å—é–¥–∞.
          </div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–õ–∏–º–∏—Ç—ã</h2>
            <button class="btn inline small" id="btn-new-limit">+ –õ–∏–º–∏—Ç</button>
          </div>
          <div id="limits-settings" class="list"></div>
          <div class="hint" style="margin-top:10px">
            –õ–∏–º–∏—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Google –¢–∞–±–ª–∏—Ü–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —á–µ—Ä–µ–∑ —Å–∞–π—Ç.
          </div>
        </div>
      </div>

      <div class="grid cols2">
        <div class="card">
          <div class="cardTitle">
            <h2>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —à–∫–∞–ª–∞: —ç—Ç–∞–ø—ã</h2>
            <button class="btn inline small" id="btn-new-stage">+ –≠—Ç–∞–ø</button>
          </div>
          <div id="stages-list" class="list"></div>
        </div>

        <div class="card">
          <div class="cardTitle">
            <h2>–ú–æ—Ç–∏–≤–∞—Ü–∏–∏ (—Ü–∏—Ç–∞—Ç—ã)</h2>
            <button class="btn inline small" id="btn-new-quote">+ –¶–∏—Ç–∞—Ç–∞</button>
          </div>
          <div class="hint" style="margin-bottom:10px">
            –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ¬´—Ü–∏—Ç–∞—Ç–∞ –¥–Ω—è¬ª. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –∏ —É–¥–∞–ª—è—Ç—å.
          </div>
          <div id="quotes-list" class="list"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- bottom nav -->
  <div class="nav" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="btnNav active" data-page="pult">
      <div class="ico">üßÆ</div><div class="lbl">–ü—É–ª—å—Ç</div>
    </div>
    <div class="btnNav" data-page="dashboard">
      <div class="ico">üìä</div><div class="lbl">–î–∞—à–±–æ—Ä–¥</div>
    </div>
    <div class="btnNav" data-page="goals">
      <div class="ico">üéØ</div><div class="lbl">–¶–µ–ª–∏</div>
    </div>
    <div class="btnNav" data-page="settings">
      <div class="ico">‚öôÔ∏è</div><div class="lbl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>
    <div class="btnNav sync" id="btn-sync">
      <div class="ico">üîÑ</div><div class="lbl">–°–∏–Ω—Ö—Ä.</div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" id="toast">
    <div class="toastTop">
      <div class="toastTitle" id="toastTitle">–°—Ç–∞—Ç—É—Å</div>
      <div class="x" id="toastClose">‚úï</div>
    </div>
    <div class="toastBody" id="toastBody"></div>
  </div>

  <!-- modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h3 id="modalTitle">–ú–æ–¥–∞–ª–∫–∞</h3>
        <div class="x" id="modalClose">‚úï</div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
/**
 * ============================
 *  CONFIG
 * ============================
 * 1) –†–∞–∑–≤–µ—Ä–Ω–∏ Google Apps Script –∫–∞–∫ Web App (/exec)
 * 2) –í—Å—Ç–∞–≤—å URL —Å—é–¥–∞
 * 3) (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≤–∫–ª—é—á–∏ API_KEY –µ—Å–ª–∏ —Ç—ã –µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –≤ GAS
 *
 * –û–ñ–ò–î–ê–ï–ú–´–ô BOOTSTRAP:
 * GET  ?action=bootstrap&key=...
 * -> { ok:true, data:{ categories, accounts, limits, operations, goals, stages, quotes } }
 *
 * –û–ñ–ò–î–ê–ï–ú–´–ï ACTIONS (POST JSON):
 * { key, action:"addOperation"|"deleteOperation"|... , data:{...} }
 */
const API_URL = "PASTE_YOUR_GAS_WEBAPP_URL_HERE";   // –Ω–∞–ø—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/XXXX/exec
const API_KEY = ""; // –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–ª—é—á –≤ GAS ‚Äî –≤—Å—Ç–∞–≤—å —Å—é–¥–∞

/**
 * ============================
 *  STATE
 * ============================
 */
const state = {
  categories: [],     // {id,name,type} type: income|expense|transfer(optional)
  accounts: [],       // {id,name}
  limits: [],         // {id, categoryId, month, amount} month: YYYY-MM
  operations: [],     // {id, createdAt, date, type, amount, categoryId, accountId, comment}
  goals: [],          // {id, name, target, saved, deadline, accountId}
  stages: [],         // {id, name, amount} amount: monthly income threshold
  quotes: [],         // {id, text, author}
  period: { kind:"week", from:null, to:null },
  lastBootstrapAt: null
};

/**
 * ============================
 *  UTIL
 * ============================
 */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const ruMoney = (n) => {
  const v = Number(n || 0);
  return v.toLocaleString("ru-RU") + " ‚ÇΩ";
};
const isoDate = (d) => {
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
};
const yyyymm = (d) => {
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  return `${yyyy}-${mm}`;
};
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

function today() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d;
}
function startOfWeek(d){
  const x = new Date(d);
  const day = (x.getDay()+6)%7; // Mon=0
  x.setDate(x.getDate()-day);
  x.setHours(0,0,0,0);
  return x;
}
function endOfWeek(d){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(e.getDate()+6);
  e.setHours(23,59,59,999);
  return e;
}
function startOfMonth(d){
  const x = new Date(d);
  x.setDate(1); x.setHours(0,0,0,0);
  return x;
}
function endOfMonth(d){
  const s = startOfMonth(d);
  const e = new Date(s);
  e.setMonth(e.getMonth()+1);
  e.setDate(0);
  e.setHours(23,59,59,999);
  return e;
}
function startOfYear(d){
  const x = new Date(d);
  x.setMonth(0,1); x.setHours(0,0,0,0);
  return x;
}
function endOfYear(d){
  const s = startOfYear(d);
  const e = new Date(s);
  e.setFullYear(e.getFullYear()+1);
  e.setDate(0);
  e.setHours(23,59,59,999);
  return e;
}
function daysBetween(a,b){
  const ms = 24*3600*1000;
  const x = new Date(a); x.setHours(0,0,0,0);
  const y = new Date(b); y.setHours(0,0,0,0);
  return Math.round((y-x)/ms);
}
function sum(arr){ return arr.reduce((s,x)=>s+Number(x||0),0); }

function catById(id){ return state.categories.find(c=>String(c.id)===String(id)); }
function accById(id){ return state.accounts.find(a=>String(a.id)===String(id)); }

function toast(title, body, type="info", autoHideMs=2500){
  const t = $("#toast");
  $("#toastTitle").textContent = title;
  $("#toastBody").textContent = body || "";
  t.classList.add("show");
  if (autoHideMs){
    window.clearTimeout(toast._tm);
    toast._tm = window.setTimeout(()=>t.classList.remove("show"), autoHideMs);
  }
}
$("#toastClose").addEventListener("click", ()=>$("#toast").classList.remove("show"));

function openModal(title, html){
  $("#modalTitle").textContent = title;
  $("#modalBody").innerHTML = html;
  $("#modalBack").classList.add("show");
}
function closeModal(){ $("#modalBack").classList.remove("show"); }
$("#modalClose").addEventListener("click", closeModal);
$("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

async function apiGet(params){
  const url = new URL(API_URL);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
  if (API_KEY) url.searchParams.set("key", API_KEY);
  const r = await fetch(url.toString(), { method:"GET" });
  const j = await r.json().catch(()=>({ok:false, error:"Invalid JSON"}));
  if (!r.ok || j.ok===false) throw new Error(j.error || `HTTP ${r.status}`);
  return j;
}
async function apiPost(action, data){
  const payload = { action, data };
  if (API_KEY) payload.key = API_KEY;
  const r = await fetch(API_URL, {
    method:"POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" }, // GAS-friendly
    body: JSON.stringify(payload)
  });
  const j = await r.json().catch(()=>({ok:false, error:"Invalid JSON"}));
  if (!r.ok || j.ok===false) throw new Error(j.error || `HTTP ${r.status}`);
  return j;
}

/**
 * ============================
 *  NAV
 * ============================
 */
function showPage(name){
  $$(".page").forEach(p=>p.classList.remove("active"));
  $("#page-"+name).classList.add("active");
  $$(".btnNav").forEach(b=>b.classList.remove("active"));
  $(`.btnNav[data-page="${name}"]`)?.classList.add("active");

  // lazy rerender
  if (name==="dashboard") renderDashboard();
  if (name==="goals") renderGoals();
  if (name==="settings") renderSettings();
}
$$(".btnNav").forEach(btn=>{
  const p = btn.getAttribute("data-page");
  if (!p) return;
  btn.addEventListener("click", ()=>showPage(p));
});
$("#btn-sync").addEventListener("click", ()=>syncAll("manual"));

/**
 * ============================
 *  BOOTSTRAP / SYNC
 * ============================
 */
async function syncAll(reason="auto"){
  toast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶", "info", 0);
  try{
    const j = await apiGet({ action:"bootstrap" });
    const d = (j.data || {});
    state.categories = Array.isArray(d.categories) ? d.categories : [];
    state.accounts   = Array.isArray(d.accounts) ? d.accounts : defaultAccounts();
    state.limits     = Array.isArray(d.limits) ? d.limits : [];
    state.operations = Array.isArray(d.operations) ? d.operations : [];
    state.goals      = Array.isArray(d.goals) ? d.goals : [];
    state.stages     = Array.isArray(d.stages) ? d.stages : defaultStages();
    state.quotes     = Array.isArray(d.quotes) ? d.quotes : defaultQuotes();
    state.lastBootstrapAt = new Date();

    normalizeState();
    toast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", "–ì–æ—Ç–æ–≤–æ ‚úÖ", "ok", 1800);

    renderAll();
  }catch(err){
    toast("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏", String(err.message || err), "error", 0);
  }
}

function defaultAccounts(){
  return [
    {id:"main", name:"–û—Å–Ω–æ–≤–Ω–æ–π"},
    {id:"card", name:"–ö–∞—Ä—Ç–∞"},
    {id:"cash", name:"–ù–∞–ª–∏—á–Ω—ã–µ"}
  ];
}
function defaultStages(){
  return [
    {id:"st1", name:"–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", amount:150000},
    {id:"st2", name:"–ö–æ–º—Ñ–æ—Ä—Ç", amount:220000},
    {id:"st3", name:"–†–æ—Å—Ç", amount:300000},
    {id:"st4", name:"–°–≤–æ–±–æ–¥–∞", amount:450000},
    {id:"st5", name:"–¶–µ–ª—å 2026", amount:600000}
  ];
}
function defaultQuotes(){
  return [
    {id:"q1", text:"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –º–æ—Å—Ç –º–µ–∂–¥—É —Ü–µ–ª—è–º–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏.", author:"–î–∂–∏–º –†–æ–Ω"},
    {id:"q2", text:"–°–Ω–∞—á–∞–ª–∞ –º—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤—ã—á–∫–∏, –∑–∞—Ç–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –Ω–∞—Å.", author:"–î–∂–æ–Ω –î—Ä–∞–π–¥–µ–Ω"},
    {id:"q3", text:"–ü–ª–∞–Ω—ã ‚Äî –Ω–∏—á—Ç–æ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤—Å—ë.", author:"–î—É–∞–π—Ç –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä"},
    {id:"q4", text:"–£—Å–ø–µ—Ö ‚Äî —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π, –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã—Ö –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.", author:"–†–æ–±–µ—Ä—Ç –ö–æ–ª—å–µ—Ä"}
  ];
}

function normalizeState(){
  // ensure ids exist
  state.categories.forEach((c,i)=>{ if(!c.id) c.id = "cat_"+i; if(!c.type) c.type="expense"; });
  state.accounts.forEach((a,i)=>{ if(!a.id) a.id = "acc_"+i; if(!a.name) a.name = "–°—á—ë—Ç "+(i+1); });
  state.operations.forEach((o,i)=>{ if(!o.id) o.id = "op_"+i; });
  state.goals.forEach((g,i)=>{ if(!g.id) g.id = "g_"+i; });
  state.stages.forEach((s,i)=>{ if(!s.id) s.id = "st_"+i; });
  state.quotes.forEach((q,i)=>{ if(!q.id) q.id = "q_"+i; });

  // sort stages asc by amount
  state.stages.sort((a,b)=>Number(a.amount)-Number(b.amount));

  // fill today date
  const d = isoDate(today());
  $("#op-date").value = $("#op-date").value || d;

  // pill month
  $("#pill-month").textContent = new Date().toLocaleString("ru-RU", {month:"long", year:"numeric"});
}

/**
 * ============================
 *  RENDER: COMMON
 * ============================
 */
function renderAll(){
  renderSelects();
  renderPult();
  if ($("#page-dashboard").classList.contains("active")) renderDashboard();
  if ($("#page-goals").classList.contains("active")) renderGoals();
  if ($("#page-settings").classList.contains("active")) renderSettings();
}

function renderSelects(){
  // category select for new op: depends on type (income/expense/transfer)
  const type = $("#op-type").value;
  const cats = state.categories.filter(c => (c.type===type) || (type==="transfer" && c.type==="transfer"));
  const catSel = $("#op-category");
  catSel.innerHTML = cats.map(c=>`<option value="${esc(c.id)}">${esc(c.name)}</option>`).join("") || `<option value="">‚Äî –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî</option>`;

  // accounts
  const accSel = $("#op-account");
  accSel.innerHTML = state.accounts.map(a=>`<option value="${esc(a.id)}">${esc(a.name)}</option>`).join("");
  if (!accSel.value) accSel.value = state.accounts[0]?.id || "";
}

$("#op-type").addEventListener("change", renderSelects);

/**
 * ============================
 *  PULT
 * ============================
 */
function renderPult(){
  renderOperations();
  renderLimitsView();
  renderSavingPlan();
}

function getMonthOps(monthYYYYMM){
  return state.operations.filter(o => yyyymm(o.date || o.createdAt || new Date()) === monthYYYYMM);
}

function renderLimitsView(){
  const month = yyyymm(new Date());
  const monthOps = getMonthOps(month).filter(o=>o.type==="expense");
  const spentByCat = {};
  for (const o of monthOps){
    const k = String(o.categoryId||"");
    spentByCat[k] = (spentByCat[k]||0) + Number(o.amount||0);
  }

  const monthLimits = state.limits.filter(l => String(l.month)===String(month));
  const limitsMap = {};
  monthLimits.forEach(l=>limitsMap[String(l.categoryId)] = l);

  // show only expense categories
  const expCats = state.categories.filter(c=>c.type==="expense");

  const rows = expCats.map(cat=>{
    const lim = limitsMap[String(cat.id)];
    const limitAmount = lim ? Number(lim.amount||0) : 0;
    const spent = Number(spentByCat[String(cat.id)]||0);
    const remaining = limitAmount > 0 ? (limitAmount - spent) : null;
    const pct = (limitAmount>0) ? clamp((spent/limitAmount)*100, 0, 160) : 0;

    const barColor = (limitAmount===0) ? "rgba(255,255,255,.25)" : (spent>limitAmount ? "rgba(255,91,110,.85)" : "rgba(87,166,255,.85)");
    const status = (limitAmount===0) ? "–õ–∏–º–∏—Ç –Ω–µ –∑–∞–¥–∞–Ω" : (spent>limitAmount ? "–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ" : "–û—Å—Ç–∞—Ç–æ–∫");

    return `
      <div class="item">
        <div class="left">
          <div class="t">${esc(cat.name)}</div>
          <div class="d">${esc(status)} ¬∑ ${limitAmount===0 ? "" : `${ruMoney(spent)} / ${ruMoney(limitAmount)}`}</div>
          <div class="progress" aria-label="progress">
            <i style="width:${pct}%; background:${barColor}"></i>
          </div>
        </div>
        <div class="right" style="flex-direction:column; align-items:flex-end">
          <div style="font-weight:900">${limitAmount===0 ? "‚Äî" : (remaining>=0 ? ruMoney(remaining) : "‚àí"+ruMoney(Math.abs(remaining)))}</div>
          <button class="btn inline small ghost" onclick="openLimitForCategory('${esc(cat.id)}')">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        </div>
      </div>
    `;
  });

  $("#limits-view").innerHTML = rows.join("") || `<div class="muted">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤.</div>`;

  // summary pill
  const totalLimit = sum(monthLimits.map(l=>Number(l.amount||0)));
  const totalSpent = sum(Object.values(spentByCat));
  const left = totalLimit>0 ? (totalLimit-totalSpent) : null;
  $("#pill-limits").textContent = totalLimit>0
    ? `–û—Å—Ç–∞—Ç–æ–∫: ${left>=0 ? ruMoney(left) : "‚àí"+ruMoney(Math.abs(left))}`
    : "–õ–∏–º–∏—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã";
}

function renderOperations(){
  const ops = [...state.operations].sort((a,b)=>new Date(b.date||b.createdAt)-new Date(a.date||a.createdAt));
  if (!ops.length){
    $("#ops-view").innerHTML = `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Å–≤–µ—Ä—Ö—É.</div>`;
    return;
  }
  // group by date
  const groups = {};
  for (const o of ops){
    const d = isoDate(o.date || o.createdAt || new Date());
    (groups[d] ||= []).push(o);
  }
  const dates = Object.keys(groups).sort((a,b)=> (a<b?1:-1));
  const html = dates.map(d=>{
    const items = groups[d].map(o=>{
      const cat = catById(o.categoryId);
      const acc = accById(o.accountId);
      const tagCls = o.type;
      const sign = o.type==="expense" ? "‚àí" : (o.type==="income" ? "+" : "‚Üî");
      const amt = ruMoney(Math.abs(Number(o.amount||0)));
      const note = (o.comment||"").trim();
      return `
        <div class="item">
          <div class="left">
            <div class="t">
              <span class="tag ${tagCls}">${o.type==="expense"?"–†–∞—Å—Ö–æ–¥":o.type==="income"?"–î–æ—Ö–æ–¥":"–ü–µ—Ä–µ–≤–æ–¥"}</span>
              <span style="margin-left:6px">${esc(cat?.name || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}</span>
            </div>
            <div class="d">${esc(acc?.name || "–°—á—ë—Ç")} ¬∑ ${note ? esc(note) : "‚Äî"}</div>
          </div>
          <div class="right">
            <div style="font-weight:950">${sign} ${amt}</div>
            <button class="btn inline small danger" onclick="confirmDeleteOp('${esc(o.id)}')">‚úï</button>
          </div>
        </div>
      `;
    }).join("");

    const pretty = new Date(d+"T00:00:00").toLocaleDateString("ru-RU", {weekday:"short", day:"2-digit", month:"long"});
    return `
      <div style="margin: 14px 0 8px; color: var(--muted); font-weight:900; font-size:12px">${esc(pretty)}</div>
      <div class="list">${items}</div>
    `;
  }).join("");

  $("#ops-view").innerHTML = html;
}

function renderSavingPlan(){
  const todayD = today();
  if (!state.goals.length){
    $("#saving-plan").innerHTML = `<div class="muted">–¶–µ–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã. –î–æ–±–∞–≤—å –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¶–µ–ª–∏¬ª.</div>`;
    return;
  }

  const html = state.goals.map(g=>{
    const target = Number(g.target||0);
    const saved = Number(g.saved||0);
    const left = Math.max(0, target - saved);
    const deadline = g.deadline ? new Date(g.deadline) : null;
    const daysLeft = deadline ? Math.max(0, daysBetween(todayD, deadline)) : null;
    const perDay = (daysLeft && daysLeft>0) ? (left/daysLeft) : null;
    const perMonth = (daysLeft && daysLeft>0) ? (left / Math.max(1, Math.ceil(daysLeft/30))) : null;
    const pct = target>0 ? clamp((saved/target)*100, 0, 100) : 0;

    return `
      <div class="item">
        <div class="left">
          <div class="t">${esc(g.name||"–¶–µ–ª—å")}</div>
          <div class="d">${ruMoney(saved)} / ${ruMoney(target)} ¬∑ ${deadline ? ("–î–µ–¥–ª–∞–π–Ω: "+deadline.toLocaleDateString("ru-RU")) : "–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞"}</div>
          <div class="progress"><i style="width:${pct}%; background: rgba(65,211,141,.85)"></i></div>
          <div class="d">
            ${left===0 ? "–¶–µ–ª—å –∑–∞–∫—Ä—ã—Ç–∞ ‚úÖ" :
              `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${perDay ? (ruMoney(perDay.toFixed(0))+" / –¥–µ–Ω—å") : (perMonth ? (ruMoney(perMonth.toFixed(0))+" / –º–µ—Å") : "–∑–∞–¥–∞–π –¥–µ–¥–ª–∞–π–Ω –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞")}`
            }
          </div>
        </div>
        <div class="right" style="flex-direction:column; align-items:flex-end">
          <div style="font-weight:900">${left===0 ? "0 ‚ÇΩ" : ruMoney(left)}</div>
          <button class="btn inline small ghost" onclick="openGoalEdit('${esc(g.id)}')">–ò–∑–º.</button>
        </div>
      </div>
    `;
  }).join("");

  $("#saving-plan").innerHTML = html;
}

/**
 * Add / Delete operations
 */
$("#btn-add-op").addEventListener("click", async ()=>{
  const type = $("#op-type").value;
  const amount = Number($("#op-amount").value);
  const categoryId = $("#op-category").value;
  const accountId = $("#op-account").value;
  const date = $("#op-date").value;
  const comment = $("#op-comment").value || "";

  if (!amount || amount<=0){
    toast("–ü—Ä–æ–≤–µ—Ä—å —Å—É–º–º—É", "–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0", "warn", 2000);
    return;
  }
  if (!date){
    toast("–ü—Ä–æ–≤–µ—Ä—å –¥–∞—Ç—É", "–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –æ–ø–µ—Ä–∞—Ü–∏–∏", "warn", 2000);
    return;
  }

  try{
    toast("–û–ø–µ—Ä–∞—Ü–∏—è", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
    await apiPost("addOperation", { type, amount, categoryId, accountId, date, comment });
    $("#op-amount").value = "";
    $("#op-comment").value = "";
    await syncAll("afterAdd");
  }catch(err){
    toast("–û—à–∏–±–∫–∞", String(err.message || err), "error", 0);
  }
});

function confirmDeleteOp(id){
  const op = state.operations.find(o=>String(o.id)===String(id));
  if (!op){ toast("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", "error", 2000); return; }
  const cat = catById(op.categoryId);
  const sign = op.type==="expense" ? "‚àí" : (op.type==="income" ? "+" : "‚Üî");
  const html = `
    <div class="muted" style="margin-bottom:10px">
      –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?
      <div style="margin-top:8px; color:var(--text); font-weight:900">
        ${sign} ${ruMoney(op.amount)} ¬∑ ${esc(cat?.name||"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")} ¬∑ ${esc(isoDate(op.date||op.createdAt))}
      </div>
    </div>
    <div class="row">
      <button class="btn danger" id="modalYes">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn secondary" id="modalNo">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", html);
  $("#modalNo").addEventListener("click", closeModal, {once:true});
  $("#modalYes").addEventListener("click", async ()=>{
    try{
      toast("–£–¥–∞–ª–µ–Ω–∏–µ", "–£–¥–∞–ª—è—é‚Ä¶", "info", 0);
      await apiPost("deleteOperation", { id });
      closeModal();
      await syncAll("afterDelete");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message || err), "error", 0);
    }
  }, {once:true});
}

$("#btn-refresh").addEventListener("click", ()=>syncAll("refresh"));

/**
 * Jump to limit edit for category
 */
function openLimitForCategory(categoryId){
  showPage("settings");
  // scroll hint: open modal editor directly
  const cat = catById(categoryId);
  openLimitEditor({ id:null, categoryId, month: yyyymm(new Date()), amount: "" }, `–õ–∏–º–∏—Ç: ${cat?.name||"–ö–∞—Ç–µ–≥–æ—Ä–∏—è"}`);
}

/**
 * ============================
 *  DASHBOARD
 * ============================
 */
function setPeriod(kind){
  state.period.kind = kind;
  if (kind!=="custom"){
    const now = new Date();
    if (kind==="week"){ state.period.from = startOfWeek(now); state.period.to = endOfWeek(now); }
    if (kind==="month"){ state.period.from = startOfMonth(now); state.period.to = endOfMonth(now); }
    if (kind==="year"){ state.period.from = startOfYear(now); state.period.to = endOfYear(now); }
  }
  $("#custom-range").style.display = (kind==="custom") ? "flex" : "none";
  renderDashboard();
}

$("#period-tabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab");
  if (!tab) return;
  $$("#period-tabs .tab").forEach(t=>t.classList.remove("active"));
  tab.classList.add("active");
  const kind = tab.getAttribute("data-period");
  setPeriod(kind);
});

$("#btn-apply-range").addEventListener("click", ()=>{
  const f = $("#range-from").value;
  const t = $("#range-to").value;
  if (!f || !t){ toast("–ü–µ—Ä–∏–æ–¥", "–í—ã–±–µ—Ä–∏ –æ–±–µ –¥–∞—Ç—ã", "warn", 2000); return; }
  const from = new Date(f+"T00:00:00");
  const to = new Date(t+"T23:59:59");
  if (from>to){ toast("–ü–µ—Ä–∏–æ–¥", "–î–∞—Ç–∞ ¬´–°¬ª –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ ¬´–ü–æ¬ª", "warn", 2200); return; }
  state.period.from = from; state.period.to = to;
  renderDashboard();
});

function opsInRange(from,to){
  const a = new Date(from); const b = new Date(to);
  return state.operations.filter(o=>{
    const d = new Date((o.date||o.createdAt));
    return d>=a && d<=b;
  });
}
function previousAnalogRange(from,to){
  const days = Math.max(1, daysBetween(from,to)+1);
  const prevTo = new Date(from);
  prevTo.setMilliseconds(prevTo.getMilliseconds()-1);
  const prevFrom = new Date(prevTo);
  prevFrom.setDate(prevFrom.getDate() - (days-1));
  prevFrom.setHours(0,0,0,0);
  return {from:prevFrom, to:prevTo};
}

function renderDashboard(){
  // init default period if not set
  if (!state.period.from || !state.period.to){
    setPeriod(state.period.kind || "week");
    return;
  }
  const from = state.period.from, to = state.period.to;
  const pretty = `${from.toLocaleDateString("ru-RU")} ‚Äî ${to.toLocaleDateString("ru-RU")}`;
  $("#pill-period").textContent = pretty;

  const curOps = opsInRange(from,to);
  const prev = previousAnalogRange(from,to);
  const prevOps = opsInRange(prev.from, prev.to);

  const curIncome = sum(curOps.filter(o=>o.type==="income").map(o=>Number(o.amount||0)));
  const curExpense = sum(curOps.filter(o=>o.type==="expense").map(o=>Number(o.amount||0)));
  const curBalance = curIncome - curExpense;

  const prevIncome = sum(prevOps.filter(o=>o.type==="income").map(o=>Number(o.amount||0)));
  const prevExpense = sum(prevOps.filter(o=>o.type==="expense").map(o=>Number(o.amount||0)));
  const prevBalance = prevIncome - prevExpense;

  const kpis = [
    { label:"–î–æ—Ö–æ–¥—ã", val:curIncome, prev:prevIncome },
    { label:"–†–∞—Å—Ö–æ–¥—ã", val:curExpense, prev:prevExpense },
    { label:"–ë–∞–ª–∞–Ω—Å",  val:curBalance, prev:prevBalance }
  ];
  $("#kpi-row").innerHTML = kpis.map(k=>{
    const deltaPct = (k.prev===0) ? (k.val===0 ? 0 : 100) : ((k.val-k.prev)/Math.abs(k.prev))*100;
    const cls = (k.val>k.prev) ? "up" : (k.val<k.prev) ? "down" : "flat";
    const arrow = (cls==="up")?"‚Üë":(cls==="down")?"‚Üì":"‚Üí";
    return `
      <div class="kpi">
        <div class="sub">${esc(k.label)} ¬∑ <span class="delta ${cls}">${arrow} ${Math.round(deltaPct)}%</span></div>
        <div class="val">${ruMoney(k.val)}</div>
        <div class="sub">–ø—Ä–µ–¥. –ø–µ—Ä–∏–æ–¥: ${ruMoney(k.prev)}</div>
      </div>
    `;
  }).join("");

  // charts
  drawBarChart($("#bar-chart"), from,to, curOps);
  drawPie($("#pie-expense"), curOps.filter(o=>o.type==="expense"), "expense");
  drawPie($("#pie-income"), curOps.filter(o=>o.type==="income"), "income");

  renderTopCategories(curOps);
}

function bucketLabel(d, kind){
  const x = new Date(d);
  if (kind==="year") return x.toLocaleString("ru-RU", {month:"short"});
  if (kind==="month") return x.toLocaleDateString("ru-RU", {day:"2-digit", month:"short"});
  if (kind==="week") return x.toLocaleDateString("ru-RU", {weekday:"short"});
  // custom: day+month
  return x.toLocaleDateString("ru-RU", {day:"2-digit", month:"short"});
}

function drawBarChart(canvas, from, to, ops){
  const ctx = canvas.getContext("2d");
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);

  ctx.clearRect(0,0,w,h);

  // determine buckets count based on range
  const days = Math.max(1, daysBetween(from,to)+1);
  let bucket = "day";
  if (state.period.kind==="year") bucket="month";
  else if (days<=7) bucket="dow";
  else bucket="day";

  // build buckets
  const buckets = [];
  const map = new Map(); // label -> {income,expense}
  const cur = new Date(from);
  cur.setHours(0,0,0,0);

  if (bucket==="month"){
    const s = new Date(from); s.setDate(1);
    const e = new Date(to);
    let it = new Date(s);
    while (it<=e){
      const lab = it.toLocaleString("ru-RU", {month:"short"});
      map.set(lab, {income:0, expense:0});
      buckets.push({key: lab});
      it.setMonth(it.getMonth()+1);
    }
    for (const o of ops){
      const d = new Date(o.date||o.createdAt);
      const lab = d.toLocaleString("ru-RU", {month:"short"});
      const b = map.get(lab);
      if (!b) continue;
      if (o.type==="income") b.income += Number(o.amount||0);
      if (o.type==="expense") b.expense += Number(o.amount||0);
    }
  } else if (bucket==="dow"){
    const labs = ["–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±","–≤—Å"];
    labs.forEach(l=>{ map.set(l,{income:0, expense:0}); buckets.push({key:l}); });
    for (const o of ops){
      const d = new Date(o.date||o.createdAt);
      const idx = (d.getDay()+6)%7;
      const lab = labs[idx];
      const b = map.get(lab);
      if (o.type==="income") b.income += Number(o.amount||0);
      if (o.type==="expense") b.expense += Number(o.amount||0);
    }
  } else {
    // day labels from range, but cap max to 14 labels for readability
    const maxLabels = 14;
    if (days > maxLabels){
      // step
      const step = Math.ceil(days / maxLabels);
      let it = new Date(from);
      let i=0;
      while (it<=to){
        const lab = it.toLocaleDateString("ru-RU", {day:"2-digit", month:"short"});
        map.set(lab,{income:0, expense:0});
        buckets.push({key: lab, date: new Date(it)});
        it.setDate(it.getDate()+step);
        i++;
        if (i>maxLabels+2) break;
      }
      // aggregate ops into nearest label by step bins
      for (const o of ops){
        const d = new Date(o.date||o.createdAt);
        // find bin by step
        const idx = Math.floor(daysBetween(from, d)/step);
        const bKey = buckets[Math.min(idx, buckets.length-1)]?.key;
        if (!bKey) continue;
        const b = map.get(bKey);
        if (o.type==="income") b.income += Number(o.amount||0);
        if (o.type==="expense") b.expense += Number(o.amount||0);
      }
    } else {
      let it = new Date(from);
      while (it<=to){
        const lab = it.toLocaleDateString("ru-RU", {day:"2-digit", month:"short"});
        map.set(lab,{income:0, expense:0});
        buckets.push({key: lab});
        it.setDate(it.getDate()+1);
      }
      for (const o of ops){
        const d = new Date(o.date||o.createdAt);
        const lab = d.toLocaleDateString("ru-RU", {day:"2-digit", month:"short"});
        const b = map.get(lab);
        if (!b) continue;
        if (o.type==="income") b.income += Number(o.amount||0);
        if (o.type==="expense") b.expense += Number(o.amount||0);
      }
    }
  }

  const data = buckets.map(b=>({label:b.key, ...map.get(b.key)}));
  const maxVal = Math.max(1, ...data.map(x=>Math.max(x.income, x.expense)));
  const pad = 12;
  const chartH = h - 40;
  const chartW = w - pad*2;

  // axis baseline
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, pad+chartH);
  ctx.lineTo(pad+chartW, pad+chartH);
  ctx.stroke();

  const n = data.length;
  const groupW = chartW / Math.max(1, n);
  const barW = Math.max(6, groupW * 0.28);
  const gap = groupW * 0.12;

  for (let i=0;i<n;i++){
    const x0 = pad + i*groupW + groupW/2;
    const incH = (data[i].income / maxVal) * (chartH-10);
    const expH = (data[i].expense / maxVal) * (chartH-10);

    // income bar
    ctx.fillStyle = "rgba(65,211,141,.85)";
    ctx.fillRect(x0 - barW - gap/2, pad+chartH - incH, barW, incH);

    // expense bar
    ctx.fillStyle = "rgba(255,91,110,.85)";
    ctx.fillRect(x0 + gap/2, pad+chartH - expH, barW, expH);

    // labels
    ctx.fillStyle = "rgba(255,255,255,.70)";
    ctx.font = "12px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(data[i].label, x0, pad+chartH + 18);
  }

  // legend
  ctx.textAlign = "left";
  ctx.font = "12px Inter, system-ui, sans-serif";
  ctx.fillStyle = "rgba(65,211,141,.9)";
  ctx.fillText("–î–æ—Ö–æ–¥—ã", pad, 16);
  ctx.fillStyle = "rgba(255,91,110,.9)";
  ctx.fillText("–†–∞—Å—Ö–æ–¥—ã", pad+72, 16);
}

function drawPie(canvas, ops, kind){
  const ctx = canvas.getContext("2d");
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,w,h);

  const byCat = {};
  for (const o of ops){
    const k = String(o.categoryId||"");
    byCat[k] = (byCat[k]||0) + Number(o.amount||0);
  }
  const entries = Object.entries(byCat)
    .map(([cid, val])=>({cid, val, name: (catById(cid)?.name || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}))
    .sort((a,b)=>b.val-a.val);

  if (!entries.length){
    ctx.fillStyle = "rgba(255,255,255,.60)";
    ctx.font = "14px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", w/2, h/2);
    return;
  }

  const total = sum(entries.map(e=>e.val));
  const cx = w*0.35, cy = h*0.52;
  const r = Math.min(w,h)*0.32;

  let ang = -Math.PI/2;
  const palette = [
    "rgba(87,166,255,.85)","rgba(65,211,141,.85)","rgba(255,204,102,.85)","rgba(255,91,110,.85)",
    "rgba(173,140,255,.85)","rgba(255,145,92,.85)","rgba(120,220,255,.85)"
  ];

  for (let i=0;i<entries.length;i++){
    const frac = entries[i].val/total;
    const a2 = ang + frac*2*Math.PI;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,ang,a2);
    ctx.closePath();
    ctx.fillStyle = palette[i % palette.length];
    ctx.fill();
    ang = a2;
  }

  // donut hole
  ctx.beginPath();
  ctx.arc(cx,cy,r*0.55,0,2*Math.PI);
  ctx.fillStyle = "rgba(15,17,21,1)";
  ctx.fill();

  // legend (top 5)
  ctx.textAlign = "left";
  ctx.font = "12px Inter, system-ui, sans-serif";
  const lx = w*0.62, ly = h*0.22;
  const top = entries.slice(0,5);
  for (let i=0;i<top.length;i++){
    const pct = Math.round((top[i].val/total)*100);
    ctx.fillStyle = palette[i % palette.length];
    ctx.fillRect(lx, ly + i*18, 10, 10);
    ctx.fillStyle = "rgba(255,255,255,.78)";
    ctx.fillText(`${top[i].name} ‚Äî ${pct}%`, lx+14, ly+9 + i*18);
  }
}

function renderTopCategories(curOps){
  const exp = curOps.filter(o=>o.type==="expense");
  const inc = curOps.filter(o=>o.type==="income");
  const top5 = (ops)=>{
    const byCat = {};
    for (const o of ops){
      const k = String(o.categoryId||"");
      byCat[k] = (byCat[k]||0) + Number(o.amount||0);
    }
    return Object.entries(byCat)
      .map(([cid,val])=>({cid,val, name: (catById(cid)?.name || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}))
      .sort((a,b)=>b.val-a.val)
      .slice(0,5);
  };

  const topE = top5(exp);
  const topI = top5(inc);

  $("#top-expense").innerHTML = topE.length ? topE.map((x,i)=>`
    <div class="item">
      <div class="left">
        <div class="t">${i+1}. ${esc(x.name)}</div>
        <div class="d">–°—É–º–º–∞: ${ruMoney(x.val)}</div>
      </div>
      <div class="right"><span class="tag expense">—Ä–∞—Å—Ö–æ–¥</span></div>
    </div>
  `).join("") : `<div class="muted">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ.</div>`;

  $("#top-income").innerHTML = topI.length ? topI.map((x,i)=>`
    <div class="item">
      <div class="left">
        <div class="t">${i+1}. ${esc(x.name)}</div>
        <div class="d">–°—É–º–º–∞: ${ruMoney(x.val)}</div>
      </div>
      <div class="right"><span class="tag income">–¥–æ—Ö–æ–¥</span></div>
    </div>
  `).join("") : `<div class="muted">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ.</div>`;
}

/**
 * ============================
 *  GOALS + MOTIVATION
 * ============================
 */
function renderGoals(){
  // goals list
  if (!state.goals.length){
    $("#goals-list").innerHTML = `<div class="muted">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏ ¬´+ –¶–µ–ª—å¬ª.</div>`;
  } else {
    $("#goals-list").innerHTML = state.goals.map(g=>{
      const target = Number(g.target||0);
      const saved = Number(g.saved||0);
      const pct = target>0 ? clamp((saved/target)*100, 0, 100) : 0;
      const d = g.deadline ? new Date(g.deadline) : null;
      const left = Math.max(0, target - saved);
      return `
        <div class="item">
          <div class="left">
            <div class="t">${esc(g.name||"–¶–µ–ª—å")}</div>
            <div class="d">${ruMoney(saved)} / ${ruMoney(target)} ¬∑ ${d ? ("–¥–æ "+d.toLocaleDateString("ru-RU")) : "–±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞"}</div>
            <div class="progress"><i style="width:${pct}%; background: rgba(87,166,255,.85)"></i></div>
            <div class="d">–û—Å—Ç–∞–ª–æ—Å—å: ${ruMoney(left)}</div>
          </div>
          <div class="right" style="flex-direction:column; align-items:flex-end">
            <button class="btn inline small ghost" onclick="openGoalEdit('${esc(g.id)}')">–ò–∑–º.</button>
            <button class="btn inline small danger" onclick="deleteGoalConfirm('${esc(g.id)}')">‚úï</button>
          </div>
        </div>
      `;
    }).join("");
  }

  // motivation: current avg monthly income from last 30 days incomes
  const now = new Date();
  const from = new Date(now); from.setDate(from.getDate()-29); from.setHours(0,0,0,0);
  const to = new Date(now); to.setHours(23,59,59,999);
  const ops = opsInRange(from,to).filter(o=>o.type==="income");
  const totalIncome30 = sum(ops.map(o=>Number(o.amount||0)));
  const curMonthly = Math.round(totalIncome30); // simple approx for MVP
  $("#mot-cur").textContent = ruMoney(curMonthly);

  // next stage
  const stages = [...state.stages].sort((a,b)=>Number(a.amount)-Number(b.amount));
  const next = stages.find(s=>Number(s.amount) > curMonthly) || stages[stages.length-1];
  $("#mot-next").textContent = next ? `${next.name} ¬∑ ${ruMoney(next.amount)}` : "‚Äî";
  const gap = next ? Math.max(0, Number(next.amount)-curMonthly) : 0;
  $("#mot-gap").textContent = ruMoney(gap);

  drawMotivationBar($("#motivation-bar"), stages, curMonthly);
}

function drawMotivationBar(canvas, stages, current){
  const ctx = canvas.getContext("2d");
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,w,h);

  if (!stages.length){
    ctx.fillStyle="rgba(255,255,255,.65)";
    ctx.font="14px Inter, system-ui, sans-serif";
    ctx.textAlign="center";
    ctx.fillText("–ù–µ—Ç —ç—Ç–∞–ø–æ–≤ —à–∫–∞–ª—ã", w/2, h/2);
    return;
  }

  const min = Number(stages[0].amount);
  const max = Number(stages[stages.length-1].amount);
  const padX = 22, padY = 16;

  // vertical bar (single)
  const barW = Math.min(90, w*0.22);
  const barX = padX + barW/2;
  const barTop = padY + 10;
  const barBottom = h - padY - 10;
  const barH = barBottom - barTop;

  // background
  ctx.strokeStyle = "rgba(255,255,255,.12)";
  ctx.lineWidth = 10;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(barX, barBottom);
  ctx.lineTo(barX, barTop);
  ctx.stroke();

  // fill to current
  const curClamped = clamp(current, min, max);
  const frac = (curClamped - min) / Math.max(1,(max-min));
  const yCur = barBottom - frac * barH;

  ctx.strokeStyle = "rgba(87,166,255,.90)";
  ctx.lineWidth = 10;
  ctx.beginPath();
  ctx.moveTo(barX, barBottom);
  ctx.lineTo(barX, yCur);
  ctx.stroke();

  // markers for stages + labels on right
  ctx.font = "12px Inter, system-ui, sans-serif";
  ctx.textAlign = "left";

  for (let i=0;i<stages.length;i++){
    const amt = Number(stages[i].amount);
    const f = (amt - min)/Math.max(1,(max-min));
    const y = barBottom - f*barH;

    // marker
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.beginPath();
    ctx.arc(barX, y, 4, 0, 2*Math.PI);
    ctx.fill();

    // label
    const lblX = barX + 18;
    ctx.fillStyle = "rgba(255,255,255,.78)";
    const name = stages[i].name || "–≠—Ç–∞–ø";
    ctx.fillText(`${name} ‚Äî ${ruMoney(amt)}`, lblX, y+4);
  }

  // current marker
  ctx.fillStyle = "rgba(65,211,141,.95)";
  ctx.beginPath();
  ctx.arc(barX, yCur, 6, 0, 2*Math.PI);
  ctx.fill();
  ctx.fillStyle = "rgba(65,211,141,.95)";
  ctx.fillText(`–°–µ–π—á–∞—Å ‚Äî ${ruMoney(current)}`, barX + 18, yCur - 10);

  // baseline label (stability requirement)
  // user asked bottom: "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî 150 000 —Ä—É–±." as default anchor.
  // If stage exists at 150k, it will already show; if not, add a hint text at bottom.
  const has150 = stages.some(s=>Number(s.amount)===150000);
  if (!has150){
    ctx.fillStyle="rgba(255,255,255,.55)";
    ctx.fillText(`–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî ${ruMoney(150000)}`, barX + 18, barBottom + 2);
  }
}

$("#btn-new-goal").addEventListener("click", ()=>openGoalEdit(null));

function openGoalEdit(id){
  const g = id ? state.goals.find(x=>String(x.id)===String(id)) : null;
  const html = `
    <div class="field">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="g-name" value="${escAttr(g?.name||"")}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç–ø—É—Å–∫, –ø–æ–¥—É—à–∫–∞, —Ç–µ—Ö–Ω–∏–∫–∞" />
    </div>
    <div class="row">
      <div class="field">
        <label>–¶–µ–ª—å (—Å—É–º–º–∞)</label>
        <input id="g-target" type="number" value="${escAttr(g?.target||"")}" placeholder="0" />
      </div>
      <div class="field">
        <label>–ù–∞–∫–æ–ø–ª–µ–Ω–æ</label>
        <input id="g-saved" type="number" value="${escAttr(g?.saved||"")}" placeholder="0" />
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>–î–µ–¥–ª–∞–π–Ω</label>
        <input id="g-deadline" type="date" value="${escAttr(g?.deadline ? isoDate(g.deadline) : "")}" />
      </div>
      <div class="field">
        <label>–°—á—ë—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <select id="g-acc">
          <option value="">‚Äî</option>
          ${state.accounts.map(a=>`<option value="${esc(a.id)}" ${String(a.id)===String(g?.accountId||"")?"selected":""}>${esc(a.name)}</option>`).join("")}
        </select>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="g-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="g-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div class="hint" style="margin-top:10px">
      –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ ¬´–ü—É–ª—å—Ç ‚Üí –ü–ª–∞–Ω –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π¬ª.
    </div>
  `;
  openModal(g ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å" : "–ù–æ–≤–∞—è —Ü–µ–ª—å", html);
  $("#g-cancel").addEventListener("click", closeModal, {once:true});
  $("#g-save").addEventListener("click", async ()=>{
    const data = {
      id: g?.id || null,
      name: $("#g-name").value.trim(),
      target: Number($("#g-target").value||0),
      saved: Number($("#g-saved").value||0),
      deadline: $("#g-deadline").value || "",
      accountId: $("#g-acc").value || ""
    };
    if (!data.name){ toast("–¶–µ–ª—å", "–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ", "warn", 2000); return; }
    if (!data.target || data.target<=0){ toast("–¶–µ–ª—å", "–¶–µ–ª—å (—Å—É–º–º–∞) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0", "warn", 2200); return; }

    try{
      toast("–¶–µ–ª–∏", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
      await apiPost("upsertGoal", data);
      closeModal();
      await syncAll("goalSave");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

function deleteGoalConfirm(id){
  const g = state.goals.find(x=>String(x.id)===String(id));
  if (!g) return;
  const html = `
    <div class="muted" style="margin-bottom:12px">
      –£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å ¬´${esc(g.name||"") }¬ª?
    </div>
    <div class="row">
      <button class="btn danger" id="yes">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn secondary" id="no">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", html);
  $("#no").addEventListener("click", closeModal, {once:true});
  $("#yes").addEventListener("click", async ()=>{
    try{
      toast("–¶–µ–ª–∏", "–£–¥–∞–ª—è—é‚Ä¶", "info", 0);
      await apiPost("deleteGoal", { id });
      closeModal();
      await syncAll("goalDelete");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

/**
 * ============================
 *  SETTINGS
 * ============================
 */
function renderSettings(){
  // categories list
  const cats = [...state.categories].sort((a,b)=>(a.type||"").localeCompare(b.type||"") || (a.name||"").localeCompare(b.name||""));
  $("#cats-list").innerHTML = cats.length ? cats.map(c=>`
    <div class="item">
      <div class="left">
        <div class="t">${esc(c.name)} <span class="tag ${esc(c.type)}" style="margin-left:8px">${c.type==="expense"?"—Ä–∞—Å—Ö–æ–¥":c.type==="income"?"–¥–æ—Ö–æ–¥":"–ø–µ—Ä–µ–≤–æ–¥"}</span></div>
        <div class="d">ID: ${esc(String(c.id))}</div>
      </div>
      <div class="right">
        <button class="btn inline small ghost" onclick="openCategoryEditor('${esc(c.id)}')">–ò–∑–º.</button>
        <button class="btn inline small danger" onclick="deleteCategoryConfirm('${esc(c.id)}')">‚úï</button>
      </div>
    </div>
  `).join("") : `<div class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é.</div>`;

  // limits settings list for current month
  const month = yyyymm(new Date());
  const lms = state.limits.filter(l=>String(l.month)===String(month));
  const byCat = {};
  lms.forEach(l=>byCat[String(l.categoryId)] = l);

  const expCats = state.categories.filter(c=>c.type==="expense");
  $("#limits-settings").innerHTML = expCats.length ? expCats.map(c=>{
    const lim = byCat[String(c.id)];
    return `
      <div class="item">
        <div class="left">
          <div class="t">${esc(c.name)}</div>
          <div class="d">–ú–µ—Å—è—Ü: ${month} ¬∑ –õ–∏–º–∏—Ç: ${lim ? ruMoney(lim.amount) : "–Ω–µ –∑–∞–¥–∞–Ω"}</div>
        </div>
        <div class="right">
          <button class="btn inline small" onclick="openLimitEditor({id:'${esc(lim?.id||"")}', categoryId:'${esc(c.id)}', month:'${month}', amount:'${esc(lim?.amount||"")}'}, '–õ–∏–º–∏—Ç: ${esc(c.name)}')">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        </div>
      </div>
    `;
  }).join("") : `<div class="muted">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤.</div>`;

  // stages list
  $("#stages-list").innerHTML = state.stages.length ? state.stages.map(s=>`
    <div class="item">
      <div class="left">
        <div class="t">${esc(s.name)} ‚Äî ${ruMoney(s.amount)}</div>
        <div class="d">ID: ${esc(String(s.id))}</div>
      </div>
      <div class="right">
        <button class="btn inline small ghost" onclick="openStageEditor('${esc(s.id)}')">–ò–∑–º.</button>
        <button class="btn inline small danger" onclick="deleteStageConfirm('${esc(s.id)}')">‚úï</button>
      </div>
    </div>
  `).join("") : `<div class="muted">–≠—Ç–∞–ø–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å –º–∏–Ω–∏–º—É–º ¬´–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å¬ª –∏ ¬´–¶–µ–ª—å 2026¬ª.</div>`;

  // quotes list
  $("#quotes-list").innerHTML = state.quotes.length ? state.quotes.map(q=>`
    <div class="item">
      <div class="left">
        <div class="t">‚Äú${esc(q.text)}‚Äù</div>
        <div class="d">${esc(q.author||"")}</div>
      </div>
      <div class="right">
        <button class="btn inline small ghost" onclick="openQuoteEditor('${esc(q.id)}')">–ò–∑–º.</button>
        <button class="btn inline small danger" onclick="deleteQuoteConfirm('${esc(q.id)}')">‚úï</button>
      </div>
    </div>
  `).join("") : `<div class="muted">–¶–∏—Ç–∞—Ç –Ω–µ—Ç. –î–æ–±–∞–≤—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>`;

  // update selects for Pult
  renderSelects();
}

$("#btn-new-cat").addEventListener("click", ()=>openCategoryEditor(null));
$("#btn-new-limit").addEventListener("click", ()=>openLimitEditor({id:null, categoryId:"", month: yyyymm(new Date()), amount:""}, "–ù–æ–≤—ã–π –ª–∏–º–∏—Ç"));
$("#btn-new-stage").addEventListener("click", ()=>openStageEditor(null));
$("#btn-new-quote").addEventListener("click", ()=>openQuoteEditor(null));

function openCategoryEditor(id){
  const c = id ? state.categories.find(x=>String(x.id)===String(id)) : null;
  const html = `
    <div class="field">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="c-name" value="${escAttr(c?.name||"")}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ï–¥–∞, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" />
    </div>
    <div class="field">
      <label>–¢–∏–ø</label>
      <select id="c-type">
        <option value="expense" ${c?.type==="expense"?"selected":""}>–†–∞—Å—Ö–æ–¥</option>
        <option value="income" ${c?.type==="income"?"selected":""}>–î–æ—Ö–æ–¥</option>
        <option value="transfer" ${c?.type==="transfer"?"selected":""}>–ü–µ—Ä–µ–≤–æ–¥</option>
      </select>
    </div>
    <div class="row">
      <button class="btn" id="c-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="c-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div class="hint" style="margin-top:10px">
      –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Google –¢–∞–±–ª–∏—Ü–µ. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ ¬´–ü—É–ª—å—Ç–µ¬ª.
    </div>
  `;
  openModal(c ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é" : "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è", html);
  $("#c-cancel").addEventListener("click", closeModal, {once:true});
  $("#c-save").addEventListener("click", async ()=>{
    const name = $("#c-name").value.trim();
    const type = $("#c-type").value;
    if (!name){ toast("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ", "warn", 2000); return; }
    try{
      toast("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
      await apiPost("upsertCategory", { id: c?.id || null, name, type });
      closeModal();
      await syncAll("catSave");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}
function deleteCategoryConfirm(id){
  const c = state.categories.find(x=>String(x.id)===String(id));
  if (!c) return;
  const html = `
    <div class="muted" style="margin-bottom:12px">
      –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´${esc(c.name)}¬ª?
      <div style="margin-top:8px" class="hint">–ï—Å–ª–∏ –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –µ—Å—Ç—å —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ–ø–µ—Ä–∞—Ü–∏—è–º –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–æ ¬´–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏¬ª (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–æ–≥–∏–∫–∏ GAS).</div>
    </div>
    <div class="row">
      <button class="btn danger" id="yes">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn secondary" id="no">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", html);
  $("#no").addEventListener("click", closeModal, {once:true});
  $("#yes").addEventListener("click", async ()=>{
    try{
      toast("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "–£–¥–∞–ª—è—é‚Ä¶", "info", 0);
      await apiPost("deleteCategory", { id });
      closeModal();
      await syncAll("catDelete");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

function openLimitEditor(lim, title="–õ–∏–º–∏—Ç"){
  const month = lim.month || yyyymm(new Date());
  const expCats = state.categories.filter(c=>c.type==="expense");
  const html = `
    <div class="field">
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (—Ä–∞—Å—Ö–æ–¥)</label>
      <select id="l-cat">
        ${expCats.map(c=>`<option value="${esc(c.id)}" ${String(c.id)===String(lim.categoryId)?"selected":""}>${esc(c.name)}</option>`).join("")}
      </select>
    </div>
    <div class="row">
      <div class="field">
        <label>–ú–µ—Å—è—Ü</label>
        <input id="l-month" value="${escAttr(month)}" placeholder="YYYY-MM" />
      </div>
      <div class="field">
        <label>–õ–∏–º–∏—Ç (‚ÇΩ)</label>
        <input id="l-amount" type="number" value="${escAttr(lim.amount||"")}" placeholder="0" />
      </div>
    </div>
    <div class="row">
      <button class="btn" id="l-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="l-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div class="hint" style="margin-top:10px">–ß—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å –ª–∏–º–∏—Ç ‚Äî –ø–æ—Å—Ç–∞–≤—å 0.</div>
  `;
  openModal(title, html);
  $("#l-cancel").addEventListener("click", closeModal, {once:true});
  $("#l-save").addEventListener("click", async ()=>{
    const categoryId = $("#l-cat").value;
    const month = $("#l-month").value.trim();
    const amount = Number($("#l-amount").value||0);
    if (!categoryId){ toast("–õ–∏–º–∏—Ç—ã", "–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é", "warn", 2000); return; }
    if (!/^\d{4}-\d{2}$/.test(month)){ toast("–õ–∏–º–∏—Ç—ã", "–ú–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM", "warn", 2200); return; }
    try{
      toast("–õ–∏–º–∏—Ç—ã", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
      await apiPost("upsertLimit", { id: lim.id || null, categoryId, month, amount });
      closeModal();
      await syncAll("limitSave");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

function openStageEditor(id){
  const s = id ? state.stages.find(x=>String(x.id)===String(id)) : null;
  const html = `
    <div class="field">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞</label>
      <input id="s-name" value="${escAttr(s?.name||"")}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å" />
    </div>
    <div class="field">
      <label>–°—É–º–º–∞ (—Å—Ä–µ–¥–Ω–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥, ‚ÇΩ)</label>
      <input id="s-amount" type="number" value="${escAttr(s?.amount||"")}" placeholder="150000" />
    </div>
    <div class="row">
      <button class="btn" id="s-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="s-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal(s ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∞–ø" : "–ù–æ–≤—ã–π —ç—Ç–∞–ø", html);
  $("#s-cancel").addEventListener("click", closeModal, {once:true});
  $("#s-save").addEventListener("click", async ()=>{
    const name = $("#s-name").value.trim();
    const amount = Number($("#s-amount").value||0);
    if (!name){ toast("–≠—Ç–∞–ø—ã", "–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ", "warn", 2000); return; }
    if (!amount || amount<=0){ toast("–≠—Ç–∞–ø—ã", "–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0", "warn", 2200); return; }
    try{
      toast("–≠—Ç–∞–ø—ã", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
      await apiPost("upsertStage", { id: s?.id || null, name, amount });
      closeModal();
      await syncAll("stageSave");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}
function deleteStageConfirm(id){
  const s = state.stages.find(x=>String(x.id)===String(id));
  if (!s) return;
  const html = `
    <div class="muted" style="margin-bottom:12px">
      –£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø ¬´${esc(s.name)}¬ª?
    </div>
    <div class="row">
      <button class="btn danger" id="yes">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn secondary" id="no">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", html);
  $("#no").addEventListener("click", closeModal, {once:true});
  $("#yes").addEventListener("click", async ()=>{
    try{
      toast("–≠—Ç–∞–ø—ã", "–£–¥–∞–ª—è—é‚Ä¶", "info", 0);
      await apiPost("deleteStage", { id });
      closeModal();
      await syncAll("stageDelete");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

function openQuoteEditor(id){
  const q = id ? state.quotes.find(x=>String(x.id)===String(id)) : null;
  const html = `
    <div class="field">
      <label>–¶–∏—Ç–∞—Ç–∞</label>
      <textarea id="q-text" placeholder="–¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã">${esc(q?.text||"")}</textarea>
    </div>
    <div class="field">
      <label>–ê–≤—Ç–æ—Ä (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="q-author" value="${escAttr(q?.author||"")}" placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞" />
    </div>
    <div class="row">
      <button class="btn" id="q-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="q-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal(q ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–∏—Ç–∞—Ç—É" : "–ù–æ–≤–∞—è —Ü–∏—Ç–∞—Ç–∞", html);
  $("#q-cancel").addEventListener("click", closeModal, {once:true});
  $("#q-save").addEventListener("click", async ()=>{
    const text = $("#q-text").value.trim();
    const author = $("#q-author").value.trim();
    if (!text){ toast("–¶–∏—Ç–∞—Ç—ã", "–¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω", "warn", 2200); return; }
    try{
      toast("–¶–∏—Ç–∞—Ç—ã", "–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶", "info", 0);
      await apiPost("upsertQuote", { id: q?.id || null, text, author });
      closeModal();
      await syncAll("quoteSave");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}
function deleteQuoteConfirm(id){
  const q = state.quotes.find(x=>String(x.id)===String(id));
  if (!q) return;
  const html = `
    <div class="muted" style="margin-bottom:12px">
      –£–¥–∞–ª–∏—Ç—å —Ü–∏—Ç–∞—Ç—É?
      <div style="margin-top:8px; color:var(--text); font-weight:900">‚Äú${esc(q.text)}‚Äù</div>
    </div>
    <div class="row">
      <button class="btn danger" id="yes">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn secondary" id="no">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", html);
  $("#no").addEventListener("click", closeModal, {once:true});
  $("#yes").addEventListener("click", async ()=>{
    try{
      toast("–¶–∏—Ç–∞—Ç—ã", "–£–¥–∞–ª—è—é‚Ä¶", "info", 0);
      await apiPost("deleteQuote", { id });
      closeModal();
      await syncAll("quoteDelete");
    }catch(err){
      toast("–û—à–∏–±–∫–∞", String(err.message||err), "error", 0);
    }
  }, {once:true});
}

/**
 * ============================
 *  QUOTE OF THE DAY (–∏—Å–ø–æ–ª—å–∑—É–π –≥–¥–µ –∑–∞—Ö–æ—á–µ—à—å)
 * ============================
 * –°–µ–π—á–∞—Å –º—ã –µ—ë –Ω–µ –≤—ã–≤–æ–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º, –Ω–æ –ª–æ–≥–∏–∫–∞ –≥–æ—Ç–æ–≤–∞.
 * –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –¥–æ–±–∞–≤–∏–º –±–ª–æ–∫ –Ω–∞ –î–∞—à–±–æ—Ä–¥ —Ä—è–¥–æ–º —Å–æ —à–∫–∞–ª–æ–π/—Ü–µ–ª—è–º–∏.
 */
function quoteOfTheDay(){
  const q = state.quotes;
  if (!q.length) return null;
  // daily rotation: index by days since epoch
  const dayIndex = Math.floor(Date.now() / (24*3600*1000));
  return q[dayIndex % q.length];
}

/**
 * ============================
 *  SECURITY / ESCAPING
 * ============================
 */
function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escAttr(s){ return esc(s).replaceAll("\n"," "); }

/**
 * ============================
 *  INIT
 * ============================
 */
(function init(){
  // set default pills
  $("#pill-month").textContent = new Date().toLocaleString("ru-RU", {month:"long", year:"numeric"});

  // initial period
  setPeriod("week");

  // resize redraw charts
  let resizeT = null;
  window.addEventListener("resize", ()=>{
    clearTimeout(resizeT);
    resizeT = setTimeout(()=>{
      if ($("#page-dashboard").classList.contains("active")) renderDashboard();
      if ($("#page-goals").classList.contains("active")) renderGoals();
    }, 120);
  });

if (!API_URL || API_URL.includes("PASTE_YOUR_GAS_WEBAPP_URL_HERE")){
  toast(
    "–ù–∞—Å—Ç—Ä–æ–π API_URL",
    "–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É Web App Google Apps Script –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É API_URL (–≤–Ω–∏–∑—É —Ñ–∞–π–ª–∞). –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏ ¬´–°–∏–Ω—Ö—Ä.¬ª",
    "warn",
    4500
  );
} else {
  syncAll("init");
}

})();
</script>
</body>
</html>
